# microservice-example

## Архитектура

![](https://i.ibb.co/rFbYhq6/Drawing-2024-11-09-17-18-59-excalidraw.png)

Архитектура представляет серверное приложение состоящие из нескольких сервисов, работающих вместе. 

Описание основных компонентов и их взаимосвязи:
1. **HAProxy Ingress**: 
   - Это точка входа для пользователей. HAProxy выступает в роли балансировщика нагрузки, распределяя входящий трафик к приложению.
   - Связан с **Application Backend** через сеть `app-net`.

2. **Application Backend**:
   - Основной сервер приложения, обрабатывающий запросы от пользователей и обращающийся к погодному сервису для получения данных о погоде.
   - Подключен к HAProxy и **Weather Service** по `app-net`.
   - Использует базу данных `app_db` на **Postgres Instance** для хранения данных приложения.

3. **Weather Service**:
   - Отвечает за обработку запросов к внешнему **OpenWeatherMap API** для получения информации о погоде.
   - Связан с **Postgres Instance** через сеть `postgres-net` для доступа к базе данных `weather_db`, где хранятся данные о погоде.
   - Подключен к Application Backend через `app-net`.

4. **Postgres Instance**:
   - База данных, используемая для хранения данных приложения (`app_db`) и информации о погоде (`weather_db`).
   - Доступен из Application Backend и Weather Service через сеть `postgres-net`.

5. **Мониторинг и Логирование (Promtail, Loki, Grafana)**:
   - **Promtail** собирает логи и отправляет их в **Loki**.
   - **Loki** хранит логи, которые можно визуализировать и анализировать с помощью **Grafana**.
   - **Grafana** обеспечивает интерфейс для мониторинга и анализа метрик и логов, что помогает отслеживать состояние всех компонентов приложения.

Все сервисы соединены внутренними сетями (`app-net` и `postgres-net`) для обеспечения безопасности и изоляции, тогда как пользователи взаимодействуют с системой через внешний интерфейс HAProxy.

## Обзор API Application backend
![](https://i.ibb.co/3RLyXrm/Screenshot-2024-11-09-at-21-25-48.png)

Наш API предоставляет следующие эндпоинты:

1. **POST /register** – регистрация нового пользователя.
2. **POST /token** – аутентификация пользователя и получение токена.
3. **GET /health-check** – проверка состояния сервиса, используемая HAProxy для мониторинга доступности и работоспособности сервиса.
4. **GET /users** – получение списка всех пользователей.
5. **GET /user/{user_id}** – получение данных конкретного пользователя по его ID.
6. **DELETE /user/{user_id}** – удаление пользователя по его ID.
7. **GET /weather/{city}** – получение данных о погоде для указанного города; при этом происходит обращение к Weather service для получения актуальной информации.

Эндпоинты организованы по типам операций: регистрация и аутентификация, операции с пользователями, проверка состояния и получение данных о погоде.

## Пример дашборда с логами
![](https://i.ibb.co/T4XMFY7/Screenshot-2024-11-09-at-21-38-42.png)

Этот дашборд отображает логи для двух сервисов:

1. **Weather service**:
   - **Cache hits log**: показывает количество обращений к кэшу для определенных городов.
   - **Requests to external API**: фиксирует запросы на получение данных о погоде от внешнего API для различных городов.

2. **Application backend**:
   - **User logins log**: фиксирует успешные входы пользователей с указанием логина.
   - **Failed login attempts log**: отображает неудачные попытки входа с указанием логина пользователя.

Дашборд предоставляет сводку по запросам к API, использованию кэша, успешным и неудачным попыткам авторизации, что удобно для мониторинга активности и состояния сервисов.
